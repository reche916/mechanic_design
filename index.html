<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>机械设计基础题库及测试</title>
    <script>
        MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script" async></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://cdn.bootcdn.net/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    
    <link rel="stylesheet" href="styles.css">
</head>
<body>


<div id="menu-toggle">
    <span></span>
    <span></span>
    <span></span>
</div>

<div id="notepad-toggle" onclick="toggleRightSidebar()">
    <i class="fa-solid fa-pen-to-square"></i>
</div>

<div id="sidebar">

    <div class="sidebar-header">导航</div>
    <div class="dark-mode-toggle">
        <span>黑暗模式</span>
        <label class="switch">
            <input type="checkbox" id="dark-mode-switch">
            <span class="slider"></span>
        </label>
    </div>
    <div class="sidebar-section">
        <h4>随机测试</h4>
        <button class="sidebar-button" onclick="startMockExam()"><i class="fa-solid fa-clock"></i> 模拟考试 (20分钟)</button>
        <button class="sidebar-button" onclick="startOverallTest('mcq')"><i class="fa-solid fa-list-check"></i> 选择题随机测试</button>
        <button class="sidebar-button" onclick="startOverallTest('tf')"><i class="fa-solid fa-check"></i> 判断题随机测试</button>
        <button class="sidebar-button wrong" onclick="startAllWrongAnswersTest()"><i class="fa-solid fa-circle-xmark"></i> 所有错题随机测试</button>
    </div>
    <div class="sidebar-section">
        <h4>数据记录</h4>
        <button class="sidebar-button" onclick="showDashboard()"><i class="fa-solid fa-chart-simple"></i> 学习统计</button>
        <button class="sidebar-button fav" onclick="showAllFavorites()"><i class="fa-solid fa-star"></i> 我的收藏</button>
        <button class="sidebar-button" onclick="showDataSync()"><i class="fa-solid fa-database"></i> 数据管理</button>
        <button class="sidebar-button" onclick="triggerWallpaperUpload()" style="margin-top: 5px;"><i class="fa-solid fa-image"></i> 设置壁纸</button>
        <input type="file" id="wallpaper-upload" accept="image/*" style="display: none;" onchange="handleWallpaperUpload(this)">
    </div>
    <div class="sidebar-section">
        <h4>章节列表</h4>
        <div id="chapter-nav-list"></div>
    </div>
</div>

<div id="main-content">
    <div class="main-container">
        <h1 id="main-title">欢迎使用机械设计基础自测题库</h1>
        
        <div class="search-container" style="max-width: 600px; margin: 0 auto 20px; position: relative;">
            <i class="fa-solid fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
            <input type="text" id="global-search" placeholder="搜索题目关键词 (如: 齿轮, 螺栓)..." oninput="filterQuestions(this.value)" style="width: 100%; padding: 12px 12px 12px 45px; border-radius: 99px; border: 1px solid var(--border); background: var(--surface-100); color: var(--text-main); font-size: 1rem; outline: none; box-shadow: var(--shadow-sm); transition: all 0.2s;">
        </div>

        <div id="global-controls">
             <button id="test-chapter-wrong-btn" onclick="startCurrentChapterWrongAnswersTest()">本章错题随机测试</button>
             <button id="clear-chapter-wrong-answers-btn" onclick="clearCurrentChapterWrongAnswers()">清空本章错题</button>
             <button id="toggle-favorites-btn" onclick="toggleFavoritesView()">只显示收藏</button>
             <button id="toggle-all-answers-btn" onclick="toggleAllAnswers()">显示全部答案</button>
        </div>
        <div id="content-area"></div>
        <div id="welcome-message" style="text-align: center; padding: 40px 0;">
            <p>请从左侧选择一个章节和题型开始练习。</p>
            <p>您也可以进行综合测试或查看您的收藏。</p>
        </div>
    </div>
</div>

<div id="quiz-modal">
    <div id="quiz-container">
        <span id="close-quiz" onclick="closeQuiz()">&times;</span>
        <div id="quiz-timer" style="position: absolute; top: 20px; right: 60px; font-weight: bold; color: var(--primary); display: none;"></div>
        <h2 id="quiz-title">随机测试</h2>
        <div id="quiz-content" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="quiz-progress"></div>
                <button id="quiz-favorite-btn" class="action-button favorite-button" style="display:none;"></button>
            </div>
            <div id="quiz-question-container">
                <p class="keyboard-instructions" id="keyboard-instructions"></p>
                <p id="quiz-question-text" style="font-size: 1.1em;"></p>
                <div id="quiz-options"></div>
            </div>
            <div id="quiz-feedback"></div>
            <div style="text-align:center; margin-top:20px;">
                <button id="submit-answer-btn" class="quiz-button" onclick="submitQuizAnswer()">提交答案</button>
                <button id="next-question-btn" class="quiz-button" onclick="nextQuizQuestion()" style="display:none;">下一题</button>
            </div>
        </div>
        <div id="quiz-score" style="display:none;"></div>
    </div>
</div>

<div id="right-sidebar">
    <h3 class="sidebar-title"><i class="fa-solid fa-pen-to-square"></i> 随手记</h3>
    <div class="notepad-container">
        <textarea id="notepad" placeholder="在这里记录公式、重点、笔记...&#10;(内容会自动保存)" oninput="saveNotepad()"></textarea>
    </div>
    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
        <button class="text-button" onclick="downloadNotepadTxt()" style="font-size: 0.85rem; color: var(--text-muted);">
            <i class="fa-solid fa-download"></i> 导出TXT
        </button>
        <button class="text-button" onclick="clearNotepad()" style="font-size: 0.85rem; color: var(--text-muted);">
            <i class="fa-solid fa-trash"></i> 清空
        </button>
    </div>
</div>

<div id="dashboard-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeDashboard()">&times;</span>
        <h2><i class="fa-solid fa-chart-pie"></i> 学习进度统计</h2>
        <div id="stats-summary" style="display:flex; justify-content:space-around; margin-bottom:20px; text-align:center;">
             <div><h3 id="stat-total">0</h3><small>刷题总数</small></div>
             <div><h3 id="stat-correct">0%</h3><small>正确率</small></div>
             <div><h3 id="stat-wrong-count">0</h3><small>当前错题</small></div>
        </div>
        <div style="overflow-y:auto; max-height:400px;">
            <table id="stats-table" style="width:100%; border-collapse:collapse;">
                <thead>
                    <tr style="border-bottom:2px solid var(--border);">
                        <th style="text-align:left; padding:10px;">章节</th>
                        <th style="width:100px;">进度</th>
                        <th style="width:60px;">正确率</th>
                    </tr>
                </thead>
                <tbody id="stats-table-body"></tbody>
            </table>
        </div>
    </div>
</div>

    </div>
</div>

<div id="cropper-modal" class="modal">
    <div class="modal-content" style="max-width: 800px; width: 95%; height: 80vh; display: flex; flex-direction: column; padding: 1.5rem;">
        <span class="close-modal" onclick="closeCropper()">&times;</span>
        <h2 style="margin-bottom: 1rem;">裁剪壁纸</h2>
        <div style="flex: 1; min-height: 0; background: #e2e8f0; position: relative; border-radius: var(--radius-md); overflow: hidden;">
            <img id="cropper-image" style="max-width: 100%; display: block;">
        </div>
        <div style="text-align: center; margin-top: 1.5rem;">
            <button class="quiz-button" onclick="confirmCrop()" style="width: auto; padding: 0.8rem 2rem; font-size: 1rem;">
                <i class="fa-solid fa-check"></i> 确认并应用
            </button>
        </div>
    </div>
</div>

<div id="data-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeDataSync()">&times;</span>
        <h2><i class="fa-solid fa-database"></i> 数据管理</h2>
        <p>导出：复制下方代码保存。导入：粘贴代码并点击恢复。</p>
        <textarea id="data-area" style="width:100%; height:150px; margin:10px 0; padding:10px; border-radius:5px; border:1px solid var(--border); font-family:monospace;"></textarea>
        <div style="text-align:right;">
            <button class="action-button" onclick="exportData()"><i class="fa-solid fa-copy"></i> 生成导出码</button>
            <button class="action-button" style="background-color:var(--primary); color:white;" onclick="importData()"><i class="fa-solid fa-file-import"></i> 恢复数据</button>
        </div>
    </div>
</div>

<script src="questions.js"></script>
<script src="app.js"></script>
</body>
</html>